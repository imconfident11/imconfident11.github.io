

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpg">
  <link rel="icon" href="/img/avatar.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Eleven">
  <meta name="keywords" content="">
  
    <meta name="description" content="写在前面 CUDA (Compute Unified Device Architecture) 是由 NVIDIA 开发的一种并行计算平台和编程模型；它允许软件开发者和研究人员利用 NVIDIA GPU 的强大并行处理能力来加速通用计算任务，而不仅仅局限于图形渲染 cuda 逆向本身不难，一般是使用 cuobjump 来获得 ptx 汇编 ，根据汇编理出加密逻辑最后进行解密即可 PTX">
<meta property="og:type" content="article">
<meta property="og:title" content="cuda 逆向">
<meta property="og:url" content="http://example.com/2025/07/21/cuda/index.html">
<meta property="og:site_name" content="Eleven&#39;s Blog">
<meta property="og:description" content="写在前面 CUDA (Compute Unified Device Architecture) 是由 NVIDIA 开发的一种并行计算平台和编程模型；它允许软件开发者和研究人员利用 NVIDIA GPU 的强大并行处理能力来加速通用计算任务，而不仅仅局限于图形渲染 cuda 逆向本身不难，一般是使用 cuobjump 来获得 ptx 汇编 ，根据汇编理出加密逻辑最后进行解密即可 PTX">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/07/21/images/cuda/a1.png">
<meta property="article:published_time" content="2025-07-20T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-06T07:10:59.951Z">
<meta property="article:author" content="Eleven">
<meta property="article:tag" content="Reverse">
<meta property="article:tag" content="cuda">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2025/07/21/images/cuda/a1.png">
  
  
  
  <title>cuda 逆向 - Eleven&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Eleven&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/wlop2.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="cuda 逆向"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-21 00:00" pubdate>
          2025年7月21日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          50 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">cuda 逆向</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="写在前面">写在前面</h4>
<p>CUDA (Compute Unified Device Architecture) 是由 NVIDIA
开发的一种并行计算平台和编程模型；它允许软件开发者和研究人员利用 NVIDIA
GPU 的强大并行处理能力来加速通用计算任务，而不仅仅局限于图形渲染</p>
<p>cuda 逆向本身不难，一般是使用 <code>cuobjump</code> 来获得 ptx 汇编
，根据汇编理出加密逻辑最后进行解密即可</p>
<h4 id="ptx-基础知识">PTX 基础知识</h4>
<p><strong>寄存器</strong>：</p>
<p><code>%p&lt;N&gt;</code>：谓词寄存器（1 位，用于条件执行）</p>
<p><code>%rs&lt;N&gt;</code>：16 位寄存器（例如 %rs1）</p>
<p><code>%r&lt;N&gt;</code>：32 位寄存器（例如 %r1）</p>
<p><code>%rd&lt;N&gt;</code>：64 位寄存器（例如 %rd1）</p>
<p><code>%f&lt;N&gt;</code>：32 位浮点寄存器（例如 %f1）</p>
<p><strong>特殊寄存器</strong>：</p>
<p><code>%tid.x</code>、<code>%tid.y</code>、<code>%tid.z</code>：线程在其线程块内的
ID</p>
<p><code>%ntid.x</code>、<code>%ntid.y</code>、<code>%ntid.z</code>：线程块的维度（每个块的线程数）</p>
<p><code>%ctaid.x</code>、<code>%ctaid.y</code>、<code>%ctaid.z</code>
：线程块在网格内的 ID</p>
<p><code>%nctaid.x</code>、<code>%nctaid.y</code>、<code>%nctaid.z</code>：网格的维度（网格中的块数）</p>
<p><strong>内存空间</strong>：</p>
<p><code>.const</code>：常量内存（只读，缓存）</p>
<p><code>.global</code>：全局内存（主要的 GPU
内存，所有线程都可访问）</p>
<p><code>.param</code>：参数内存（用于内核函数的参数）</p>
<p><strong>常见指令</strong>：</p>
<p><code>ld</code>：从内存加载数据</p>
<p><code>st</code>：将数据存储到内存</p>
<p><code>mov</code>：在寄存器之间移动值</p>
<p><code>add、sub、mul、shl、shr</code>：加、减、乘、左移、右移</p>
<p><code>and、or、xor</code>：按位与、按位或、异或</p>
<p><code>setp</code>：根据比较结果设置谓词寄存器</p>
<p><strong><code>bra</code>：分支（无条件跳转）</strong> (jmp)</p>
<p><code>@%pX bra</code>：条件分支（如果谓词 %pX 为真，则跳转）</p>
<p><code>ret</code>：从内核返回</p>
<p><strong><code>bar.sync</code>：同步线程块内的所有线程</strong></p>
<p><code>cvta.to.global.u64</code>：将地址转换为全局内存地址</p>
<p><code>cvt</code>：数据类型转换</p>
<p><code>fma.rn.f32</code>：融合乘加（float32，四舍五入到最近的）</p>
<p><strong><code>mad.lo.s32</code>：乘加（有符号 32 位，结果的低 32
位）</strong> (a * b + c)</p>
<p><code>mul.wide.u32</code>：乘法（无符号 32 位，生成 64 位结果）</p>
<h3 id="actf-2025-deeptx">ACTF 2025 Deeptx</h3>
<h4 id="分析">分析</h4>
<p>附件先扔 ida，看到 main</p>
<p><img src="/images/cuda/a1.png" srcset="/img/loading.gif" lazyload /></p>
<p>主要步骤:打开并验证 bmp 图像 -&gt; 读取调色板和像素数据 -&gt; 将
S-box、T-box 和 motion 表复制到 GPU 常量内存 -&gt; 调用三层 cuda
处理(Layer1、Layer2、Layer3) -&gt; 保存处理后的图像</p>
<p>使用 cuobjdump.exe,<code>cuobjdump --dump-ptx quiz</code>， dump
出汇编</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><code class="hljs cpp">.<span class="hljs-type">const</span> .align <span class="hljs-number">1</span> .b8 cuda_sbox[<span class="hljs-number">256</span>]; <br>.<span class="hljs-type">const</span> .align <span class="hljs-number">1</span> .b8 cuda_tbox[<span class="hljs-number">256</span>]; <br>.<span class="hljs-type">const</span> .align <span class="hljs-number">4</span> .b8 cuda_motion[<span class="hljs-number">1024</span>]; <br><br>.visible .entry _Z6Layer1PhS_(  <br>.param .u64 _Z6Layer1PhS__param_0,<br>.param .u64 _Z6Layer1PhS__param_1 <br>)<br>&#123;<br>.reg .pred %p&lt;<span class="hljs-number">6</span>&gt;;<br>.reg .b16 %rs&lt;<span class="hljs-number">2</span>&gt;;<br>.reg .f32 %f&lt;<span class="hljs-number">12</span>&gt;;<br>.reg .b32 %r&lt;<span class="hljs-number">23</span>&gt;;<br>.reg .b64 %rd&lt;<span class="hljs-number">15</span>&gt;;<br><br>ld.param.u64 %rd5, [_Z6Layer1PhS__param_0];<br>ld.param.u64 %rd6, [_Z6Layer1PhS__param_1];<br>mov.u32 %r1, %tid.x;<br>setp.lt.u32 %p1, %r1, <span class="hljs-number">241</span>;<br>mov.u32 %r2, %ctaid.x;<br>setp.lt.u32 %p2, %r2, <span class="hljs-number">241</span>;<br><span class="hljs-keyword">and</span>.pred %p3, %p1, %p2;<br>@%p3 bra $L__BB0_2;<br>bra.uni $L__BB0_1;<br><br>$L__BB0_2:<br>mov.u32 %r3, %ntid.x;<br>cvta.to.global.u64 %rd1, %rd5;<br>mov.f32 %f10, <span class="hljs-number">0</span>f00000000;<br>mov.u32 %r11, <span class="hljs-number">0</span>;<br>mov.u64 %rd8, cuda_motion;<br>mov.u32 %r20, %r11;<br><br>$L__BB0_3:<br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>;<br>add.s32 %r13, %r20, %r2;<br>shl.b32 %r14, %r20, <span class="hljs-number">4</span>;<br>mov.u32 %r15, <span class="hljs-number">240</span>;<br>sub.s32 %r16, %r15, %r14;<br>mad.lo.s32 %r21, %r13, %r3, %r1;<br>mul.wide.u32 %rd7, %r16, <span class="hljs-number">4</span>;<br>add.s64 %rd14, %rd8, %rd7;<br>mov.u32 %r22, %r11;<br><br>$L__BB0_4:<br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd9, %r21;<br>add.s64 %rd10, %rd1, %rd9;<br>ld.global.u8 %rs1, [%rd10];<br>cvt.rn.f<span class="hljs-number">32.</span>u16 %f7, %rs1;<br>ld.<span class="hljs-type">const</span>.f32 %f8, [%rd14];<br>fma.rn.f32 %f10, %f8, %f7, %f10;<br>add.s32 %r21, %r21, <span class="hljs-number">1</span>;<br>add.s64 %rd14, %rd14, <span class="hljs-number">4</span>;<br>add.s32 %r22, %r22, <span class="hljs-number">1</span>;<br>setp.ne.s32 %p4, %r22, <span class="hljs-number">16</span>;<br>@%p4 bra $L__BB0_4;<br><br>add.s32 %r20, %r20, <span class="hljs-number">1</span>;<br>setp.lt.u32 %p5, %r20, <span class="hljs-number">16</span>;<br>@%p5 bra $L__BB0_3;<br>bra.uni $L__BB0_6;<br><br>$L__BB0_1:<br>mov.f32 %f10, <span class="hljs-number">0</span>f00000000;<br><br>$L__BB0_6:<br>cvt.rzi.u<span class="hljs-number">32.f32</span> %r17, %f10;<br>mov.u32 %r18, %ntid.x;<br>mad.lo.s32 %r19, %r2, %r18, %r1;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd11, %r19;<br>cvta.to.global.u64 %rd12, %rd6;<br>add.s64 %rd13, %rd12, %rd11;<br>st.global.u8 [%rd13], %r17;<br>ret;<br><br>&#125;<br><span class="hljs-comment">//</span><br>.visible .entry _Z6Layer2PhS_(<br>.param .u64 _Z6Layer2PhS__param_0,<br>.param .u64 _Z6Layer2PhS__param_1<br>)<br>&#123;<br>.reg .b16 %rs&lt;<span class="hljs-number">2</span>&gt;;<br>.reg .b32 %r&lt;<span class="hljs-number">8</span>&gt;;<br>.reg .b64 %rd&lt;<span class="hljs-number">14</span>&gt;;<br><br><br>ld.param.u64 %rd1, [_Z6Layer2PhS__param_0];<br>ld.param.u64 %rd2, [_Z6Layer2PhS__param_1];<br>cvta.to.global.u64 %rd3, %rd2;<br>cvta.to.global.u64 %rd4, %rd1;<br>mov.u32 %r1, %ctaid.x;<br>mov.u32 %r2, %ntid.x;<br>mov.u32 %r3, %tid.x;<br>mad.lo.s32 %r4, %r1, %r2, %r3;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd5, %r4;<br>add.s64 %rd6, %rd4, %rd5;<br>ld.global.u8 %rs1, [%rd6];<br>cvt.u<span class="hljs-number">64.</span>u32 %rd7, %r3;<br>mov.u64 %rd8, cuda_sbox;<br>add.s64 %rd9, %rd8, %rd7;<br>ld.<span class="hljs-type">const</span>.u8 %r5, [%rd9];<br>cvt.u<span class="hljs-number">64.</span>u32 %rd10, %r1;<br>add.s64 %rd11, %rd8, %rd10;<br>ld.<span class="hljs-type">const</span>.u8 %r6, [%rd11];<br>mad.lo.s32 %r7, %r2, %r5, %r6;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd12, %r7;<br>add.s64 %rd13, %rd3, %rd12;<br>st.global.u8 [%rd13], %rs1;<br>ret;<br><br>&#125;<br><span class="hljs-comment">//</span><br>.visible .entry _Z6Layer3PhS_(<br>.param .u64 _Z6Layer3PhS__param_0,<br>.param .u64 _Z6Layer3PhS__param_1<br>)<br>&#123;<br>.reg .pred %p&lt;<span class="hljs-number">5</span>&gt;;<br>.reg .b16 %rs&lt;<span class="hljs-number">33</span>&gt;;<br>.reg .b32 %r&lt;<span class="hljs-number">52</span>&gt;;<br>.reg .b64 %rd&lt;<span class="hljs-number">24</span>&gt;;<br><br><br>ld.param.u64 %rd6, [_Z6Layer3PhS__param_0];<br>ld.param.u64 %rd5, [_Z6Layer3PhS__param_1];<br>mov.u32 %r21, %ntid.x;<br>mov.u32 %r1, %ctaid.x;<br>mul.lo.s32 %r49, %r1, %r21;<br>mov.u32 %r3, %tid.x;<br>add.s32 %r22, %r49, %r3;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd1, %r22;<br>cvta.to.global.u64 %rd2, %rd6;<br>add.s64 %rd3, %rd2, %rd1;<br>cvt.u<span class="hljs-number">16.</span>u32 %rs8, %r3;<br>cvt.u<span class="hljs-number">16.</span>u32 %rs9, %r1;<br><span class="hljs-keyword">or</span>.b16 %rs10, %rs9, %rs8;<br>ld.global.u8 %rs11, [%rd3];<br><span class="hljs-keyword">xor</span>.b16 %rs12, %rs11, %rs10;<br>st.global.u8 [%rd3], %rs12;<br>bar.sync <span class="hljs-number">0</span>;<br><span class="hljs-keyword">and</span>.b32 %r23, %r3, <span class="hljs-number">7</span>;<br>setp.ne.s32 %p1, %r23, <span class="hljs-number">0</span>;<br>@%p1 bra $L__BB2_4;<br><br>ld.global.u32 %r47, [%rd3<span class="hljs-number">+4</span>];<br>ld.global.u32 %r48, [%rd3];<br>mov.u32 %r46, <span class="hljs-number">1786956040</span>;<br>mov.u32 %r45, <span class="hljs-number">0</span>;<br><br>$L__BB2_2:<br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>;<br>shl.b32 %r26, %r48, <span class="hljs-number">4</span>;<br>add.s32 %r27, %r26, <span class="hljs-number">1386807340</span>;<br>shr.u32 %r28, %r48, <span class="hljs-number">5</span>;<br>add.s32 %r29, %r28, <span class="hljs-number">2007053320</span>;<br><span class="hljs-keyword">xor</span>.b32 %r30, %r29, %r27;<br>add.s32 %r31, %r48, %r46;<br><span class="hljs-keyword">xor</span>.b32 %r32, %r30, %r31;<br>add.s32 %r47, %r32, %r47;<br>shl.b32 %r33, %r47, <span class="hljs-number">4</span>;<br>add.s32 %r34, %r33, <span class="hljs-number">621668851</span>;<br>add.s32 %r35, %r46, %r47;<br><span class="hljs-keyword">xor</span>.b32 %r36, %r34, %r35;<br>shr.u32 %r37, %r47, <span class="hljs-number">5</span>;<br>add.s32 %r38, %r37, <span class="hljs-number">-862448841</span>;<br><span class="hljs-keyword">xor</span>.b32 %r39, %r36, %r38;<br>sub.s32 %r48, %r48, %r39;<br>add.s32 %r46, %r46, <span class="hljs-number">-1708609273</span>;<br>add.s32 %r45, %r45, <span class="hljs-number">1</span>;<br>setp.ne.s32 %p2, %r45, <span class="hljs-number">3238567</span>;<br>@%p2 bra $L__BB2_2;<br><br>st.global.u32 [%rd3], %r48;<br>st.global.u32 [%rd3<span class="hljs-number">+4</span>], %r47;<br><br>$L__BB2_4:<br>bar.sync <span class="hljs-number">0</span>;<br><span class="hljs-keyword">and</span>.b16 %rs16, %rs9, %rs8;<br>ld.global.u8 %rs17, [%rd3];<br><span class="hljs-keyword">xor</span>.b16 %rs18, %rs17, %rs16;<br>st.global.u8 [%rd3], %rs18;<br>bar.sync <span class="hljs-number">0</span>;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd7, %r3;<br>mov.u64 %rd8, cuda_sbox;<br>add.s64 %rd9, %rd8, %rd7;<br>ld.<span class="hljs-type">const</span>.u8 %rs31, [%rd9];<br>cvta.to.global.u64 %rd4, %rd5;<br>mov.u16 %rs32, <span class="hljs-number">0</span>;<br>mov.u32 %r50, <span class="hljs-number">0</span>;<br>mov.u64 %rd14, cuda_tbox;<br><br>$L__BB2_5:<br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd10, %r49;<br>add.s64 %rd11, %rd2, %rd10;<br>cvt.u<span class="hljs-number">64.</span>u16 %rd12, %rs31;<br><span class="hljs-keyword">and</span>.b64 %rd13, %rd12, <span class="hljs-number">255</span>;<br>add.s64 %rd15, %rd14, %rd13;<br>ld.<span class="hljs-type">const</span>.u8 %rs19, [%rd15];<br>ld.global.u8 %rs20, [%rd11];<br>mul.lo.s16 %rs21, %rs19, %rs20;<br>add.s16 %rs32, %rs21, %rs32;<br>mul.lo.s16 %rs22, %rs31, <span class="hljs-number">5</span>;<br>add.s16 %rs31, %rs22, <span class="hljs-number">17</span>;<br>add.s32 %r49, %r49, <span class="hljs-number">1</span>;<br>add.s32 %r50, %r50, <span class="hljs-number">1</span>;<br>setp.ne.s32 %p3, %r50, <span class="hljs-number">256</span>;<br>@%p3 bra $L__BB2_5;<br><br><span class="hljs-keyword">xor</span>.b32 %r18, %r1, %r3;<br>mov.u32 %r51, <span class="hljs-number">8</span>;<br><br>$L__BB2_7:<br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>;<br>shl.b16 %rs23, %rs32, <span class="hljs-number">3</span>;<br><span class="hljs-keyword">and</span>.b16 %rs24, %rs32, <span class="hljs-number">224</span>;<br>shr.u16 %rs25, %rs24, <span class="hljs-number">5</span>;<br><span class="hljs-keyword">or</span>.b16 %rs26, %rs25, %rs23;<br>cvt.u<span class="hljs-number">32.</span>u16 %r42, %rs26;<br>mad.lo.s32 %r43, %r42, <span class="hljs-number">13</span>, %r18;<br><span class="hljs-keyword">and</span>.b32 %r44, %r51, <span class="hljs-number">255</span>;<br>cvt.u<span class="hljs-number">64.</span>u32 %rd16, %r44;<br>add.s64 %rd18, %rd14, %rd16;<br>cvt.u<span class="hljs-number">16.</span>u32 %rs27, %r43;<br>ld.<span class="hljs-type">const</span>.u8 %rs28, [%rd18];<br><span class="hljs-keyword">xor</span>.b16 %rs29, %rs28, %rs27;<br>cvt.u<span class="hljs-number">64.</span>u16 %rd19, %rs29;<br><span class="hljs-keyword">and</span>.b64 %rd20, %rd19, <span class="hljs-number">255</span>;<br>add.s64 %rd22, %rd8, %rd20;<br>ld.<span class="hljs-type">const</span>.u8 %rs32, [%rd22];<br>add.s32 %r51, %r51, <span class="hljs-number">1</span>;<br>setp.ne.s32 %p4, %r51, <span class="hljs-number">4137823</span>;<br>@%p4 bra $L__BB2_7;<br><br>add.s64 %rd23, %rd4, %rd1;<br>st.global.u8 [%rd23], %rs32;<br>ret;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="layer1"><strong>Layer1</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs cpp">.visible .entry _Z6Layer1PhS_(<br>.param .u64 _Z6Layer1PhS__param_0,<br>.param .u64 _Z6Layer1PhS__param_1<br>)<br>&#123;<br>.reg .pred %p&lt;<span class="hljs-number">6</span>&gt;;<br>.reg .b16 %rs&lt;<span class="hljs-number">2</span>&gt;;<br>.reg .f32 %f&lt;<span class="hljs-number">12</span>&gt;;<br>.reg .b32 %r&lt;<span class="hljs-number">23</span>&gt;;<br>.reg .b64 %rd&lt;<span class="hljs-number">15</span>&gt;;<br><br><span class="hljs-comment">// 加载内核参数（指向全局内存的指针）</span><br>ld.param.u64 %rd5, [_Z6Layer1PhS__param_0]; <span class="hljs-comment">// %rd5 = input_ptr (第一个参数)</span><br>ld.param.u64 %rd6, [_Z6Layer1PhS__param_1]; <span class="hljs-comment">// %rd6 = output_ptr (第二个参数)</span><br><br><span class="hljs-comment">// 获取线程和块 ID</span><br>mov.u32 %r1, %tid.x;   <span class="hljs-comment">// %r1 = 当前线程在其块内的 x 轴 ID</span><br>mov.u32 %r2, %ctaid.x; <span class="hljs-comment">// %r2 = 当前块在网格内的 x 轴 ID</span><br><br><span class="hljs-comment">// 基于线程和块 ID 的条件执行</span><br>setp.lt.u32 %p1, %r1, <span class="hljs-number">241</span>; <span class="hljs-comment">// %p1 = 如果 %tid.x &lt; 241，则为真</span><br>setp.lt.u32 %p2, %r2, <span class="hljs-number">241</span>; <span class="hljs-comment">// %p2 = 如果 %ctaid.x &lt; 241，则为真</span><br><span class="hljs-keyword">and</span>.pred %p3, %p1, %p2;    <span class="hljs-comment">// %p3 = 如果 (%tid.x &lt; 241) 且 (%ctaid.x &lt; 241)，则为真</span><br><br>@%p3 bra $L__BB0_2; <span class="hljs-comment">// 如果 %p3 为真，则跳转到 $L__BB0_2 (主计算部分)</span><br>bra.uni $L__BB0_1;   <span class="hljs-comment">// 否则，无条件跳转到 $L__BB0_1 (跳过计算)</span><br><br>$L__BB0_2: <span class="hljs-comment">// 主计算路径（如果线程/块 ID 在范围内）</span><br>mov.u32 %r3, %ntid.x;     <span class="hljs-comment">// %r3 = 线程块在 x 轴的线程数</span><br>cvta.to.global.u64 %rd1, %rd5; <span class="hljs-comment">// 将 input_ptr 转换为全局内存地址。%rd1 现在指向输入数据。</span><br>mov.f32 %f10, <span class="hljs-number">0</span>f00000000; <span class="hljs-comment">// %f10 = 0.0 (浮点求和的累加器)</span><br>mov.u32 %r11, <span class="hljs-number">0</span>;          <span class="hljs-comment">// %r11 = 循环计数器初始化</span><br>mov.u64 %rd8, cuda_motion; <span class="hljs-comment">// %rd8 = cuda_motion 常量数组的基地址</span><br>mov.u32 %r20, %r11;       <span class="hljs-comment">// %r20 = 外层循环计数器（初始化为 0）</span><br><br>$L__BB0_3: <span class="hljs-comment">// 外层循环（迭代 16 次）</span><br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>; <span class="hljs-comment">// 编译器提示：不要展开此循环。</span><br>add.s32 %r13, %r20, %r2;    <span class="hljs-comment">// %r13 = outer_loop_counter + block_id.x</span><br>shl.b32 %r14, %r20, <span class="hljs-number">4</span>;      <span class="hljs-comment">// %r14 = outer_loop_counter * 16 (每个浮点数 4 字节，每个内层循环 16 个元素)</span><br>mov.u32 %r15, <span class="hljs-number">240</span>;          <span class="hljs-comment">// %r15 = 240 (常量)</span><br>sub.s32 %r16, %r15, %r14;   <span class="hljs-comment">// %r16 = 240 - (outer_loop_counter * 16)</span><br>mad.lo.s32 %r21, %r13, %r3, %r1; <span class="hljs-comment">// %r21 = (outer_loop_counter + block_id.x) * num_threads_per_block + thread_id.x</span><br>                               <span class="hljs-comment">// 这计算了访问输入数据的全局索引。</span><br>mul.wide.u32 %rd7, %r16, <span class="hljs-number">4</span>; <span class="hljs-comment">// %rd7 = (240 - (outer_loop_counter * 16)) * 4。这计算了 cuda_motion 中的偏移量。</span><br>add.s64 %rd14, %rd8, %rd7;  <span class="hljs-comment">// %rd14 = cuda_motion 的地址 + 计算出的偏移量。这是此内层循环中 cuda_motion 中权重的起始地址。</span><br>mov.u32 %r22, %r11;         <span class="hljs-comment">// %r22 = 内层循环计数器（初始化为 0）</span><br><br>$L__BB0_4: <span class="hljs-comment">// 内层循环（迭代 16 次）</span><br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>; <span class="hljs-comment">// 编译器提示：不要展开此循环。</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd9, %r21;    <span class="hljs-comment">// 将输入索引转换为 64 位以进行地址计算</span><br>add.s64 %rd10, %rd1, %rd9; <span class="hljs-comment">// %rd10 = input_ptr + input_index。输入字节的地址。</span><br>ld.global.u8 %rs1, [%rd10]; <span class="hljs-comment">// 从全局输入内存加载 1 字节到 %rs1 (16 位寄存器)</span><br>cvt.rn.f<span class="hljs-number">32.</span>u16 %f7, %rs1;  <span class="hljs-comment">// 将加载的字节（作为无符号 16 位）转换为 float32 (%f7) (四舍五入到最近的整数)</span><br>ld.<span class="hljs-type">const</span>.f32 %f8, [%rd14]; <span class="hljs-comment">// 从 cuda_motion 加载 4 字节（一个 float32）到 %f8 (这是一个权重)</span><br>fma.rn.f32 %f10, %f8, %f7, %f10; <span class="hljs-comment">// 融合乘加： %f10 = (%f8 * %f7) + %f10。累加加权和。</span><br>add.s32 %r21, %r21, <span class="hljs-number">1</span>;     <span class="hljs-comment">// 递增输入索引，用于下一次迭代</span><br>add.s64 %rd14, %rd14, <span class="hljs-number">4</span>;   <span class="hljs-comment">// 递增 cuda_motion 地址 4 字节（浮点数大小）</span><br>add.s32 %r22, %r22, <span class="hljs-number">1</span>;     <span class="hljs-comment">// 递增内层循环计数器</span><br>setp.ne.s32 %p4, %r22, <span class="hljs-number">16</span>; <span class="hljs-comment">// %p4 = 如果 inner_loop_counter != 16，则为真</span><br>@%p4 bra $L__BB0_4;        <span class="hljs-comment">// 如果 %p4 为真，继续内层循环</span><br><br>add.s32 %r20, %r20, <span class="hljs-number">1</span>;     <span class="hljs-comment">// 递增外层循环计数器</span><br>setp.lt.u32 %p5, %r20, <span class="hljs-number">16</span>; <span class="hljs-comment">// %p5 = 如果 outer_loop_counter &lt; 16，则为真</span><br>@%p5 bra $L__BB0_3;        <span class="hljs-comment">// 如果 %p5 为真，继续外层循环</span><br>bra.uni $L__BB0_6;         <span class="hljs-comment">// 循环完成后，无条件跳转到 $L__BB0_6</span><br><br>$L__BB0_1: <span class="hljs-comment">// 对于超出范围的线程/块的路径</span><br>mov.f32 %f10, <span class="hljs-number">0</span>f00000000; <span class="hljs-comment">// 将累加器初始化为 0.0 (它们实际上不进行计算)</span><br><br>$L__BB0_6: <span class="hljs-comment">// 计算或跳过后的通用代码路径</span><br>cvt.rzi.u<span class="hljs-number">32.f32</span> %r17, %f10; <span class="hljs-comment">// 将累加的 float32 值 (%f10) 转换为无符号 32 位整数，向零舍入。</span><br>mov.u32 %r18, %ntid.x;      <span class="hljs-comment">// %r18 = 线程块在 x 轴的线程数</span><br>mad.lo.s32 %r19, %r2, %r18, %r1; <span class="hljs-comment">// %r19 = block_id.x * num_threads_per_block + thread_id.x (全局线程索引)</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd11, %r19;    <span class="hljs-comment">// 将全局线程索引转换为 64 位</span><br>cvta.to.global.u64 %rd12, %rd6; <span class="hljs-comment">// 将 output_ptr 转换为全局内存地址。%rd12 指向输出数据。</span><br>add.s64 %rd13, %rd12, %rd11; <span class="hljs-comment">// %rd13 = output_ptr + global_thread_index。写入输出的地址。</span><br>st.global.u8 [%rd13], %r17; <span class="hljs-comment">// 将 %r17 的低 8 位（结果）存储到全局输出内存。</span><br>ret; <span class="hljs-comment">// 从内核返回。</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="layer2"><strong>Layer2</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs cpp">.visible .entry _Z6Layer2PhS_(<br>.param .u64 _Z6Layer2PhS__param_0,<br>.param .u64 _Z6Layer2PhS__param_1<br>)<br>&#123;<br>.reg .b16 %rs&lt;<span class="hljs-number">2</span>&gt;;<br>.reg .b32 %r&lt;<span class="hljs-number">8</span>&gt;;<br>.reg .b64 %rd&lt;<span class="hljs-number">14</span>&gt;;<br><br><span class="hljs-comment">// 加载内核参数（指向全局内存的指针）</span><br>ld.param.u64 %rd1, [_Z6Layer2PhS__param_0]; <span class="hljs-comment">// %rd1 = input_ptr</span><br>ld.param.u64 %rd2, [_Z6Layer2PhS__param_1]; <span class="hljs-comment">// %rd2 = output_ptr</span><br><br><span class="hljs-comment">// 将指针转换为全局内存地址</span><br>cvta.to.global.u64 %rd3, %rd2; <span class="hljs-comment">// %rd3 = global_output_ptr</span><br>cvta.to.global.u64 %rd4, %rd1; <span class="hljs-comment">// %rd4 = global_input_ptr</span><br><br><span class="hljs-comment">// 获取线程和块 ID 并计算全局线程索引</span><br>mov.u32 %r1, %ctaid.x;   <span class="hljs-comment">// %r1 = block_id.x</span><br>mov.u32 %r2, %ntid.x;   <span class="hljs-comment">// %r2 = num_threads_per_block.x</span><br>mov.u32 %r3, %tid.x;    <span class="hljs-comment">// %r3 = thread_id.x</span><br>mad.lo.s32 %r4, %r1, %r2, %r3; <span class="hljs-comment">// %r4 = block_id.x * num_threads_per_block.x + thread_id.x (全局线程索引)</span><br><br><span class="hljs-comment">// 读取输入字节</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd5, %r4;    <span class="hljs-comment">// 将全局线程索引转换为 64 位</span><br>add.s64 %rd6, %rd4, %rd5; <span class="hljs-comment">// %rd6 = global_input_ptr + global_thread_index。要读取的地址。</span><br>ld.global.u8 %rs1, [%rd6]; <span class="hljs-comment">// 从全局输入内存加载 1 字节到 %rs1</span><br><br><span class="hljs-comment">// 执行 S 盒查找</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd7, %r3;    <span class="hljs-comment">// 将 thread_id.x 转换为 64 位以作为索引</span><br>mov.u64 %rd8, cuda_sbox;  <span class="hljs-comment">// %rd8 = cuda_sbox 的基地址</span><br>add.s64 %rd9, %rd8, %rd7; <span class="hljs-comment">// %rd9 = cuda_sbox_base + thread_id.x。用于 S 盒查找的地址。</span><br>ld.<span class="hljs-type">const</span>.u8 %r5, [%rd9];  <span class="hljs-comment">// 从 cuda_sbox 中以 thread_id.x 为索引加载 1 字节到 %r5</span><br><br>cvt.u<span class="hljs-number">64.</span>u32 %rd10, %r1;   <span class="hljs-comment">// 将 block_id.x 转换为 64 位以作为索引</span><br>add.s64 %rd11, %rd8, %rd10; <span class="hljs-comment">// %rd11 = cuda_sbox_base + block_id.x。用于另一次 S 盒查找的地址。</span><br>ld.<span class="hljs-type">const</span>.u8 %r6, [%rd11]; <span class="hljs-comment">// 从 cuda_sbox 中以 block_id.x 为索引加载 1 字节到 %r6</span><br><br><span class="hljs-comment">// 计算输出地址偏移</span><br>mad.lo.s32 %r7, %r2, %r5, %r6; <span class="hljs-comment">// %r7 = num_threads_per_block.x * S_box_val(thread_id.x) + S_box_val(block_id.x)</span><br>                               <span class="hljs-comment">// 这计算了写入输出的最终偏移量。</span><br><br><span class="hljs-comment">// 写入输出</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd12, %r7;   <span class="hljs-comment">// 将计算出的偏移量转换为 64 位</span><br>add.s64 %rd13, %rd3, %rd12; <span class="hljs-comment">// %rd13 = global_output_ptr + calculated_offset。最终输出地址。</span><br>st.global.u8 [%rd13], %rs1; <span class="hljs-comment">// 将输入字节 (%rs1) 存储到计算出的输出地址。</span><br>ret; <span class="hljs-comment">// 从内核返回。</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="layer3"><strong>Layer3</strong></h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs cpp">.visible .entry _Z6Layer3PhS_(<br>.param .u64 _Z6Layer3PhS__param_0,<br>.param .u64 _Z6Layer3PhS__param_1<br>)<br>&#123;<br>.reg .pred %p&lt;<span class="hljs-number">5</span>&gt;;<br>.reg .b16 %rs&lt;<span class="hljs-number">33</span>&gt;;<br>.reg .b32 %r&lt;<span class="hljs-number">52</span>&gt;;<br>.reg .b64 %rd&lt;<span class="hljs-number">24</span>&gt;;<br><br><span class="hljs-comment">// 加载内核参数（指向全局内存的指针）</span><br>ld.param.u64 %rd6, [_Z6Layer3PhS__param_0]; <span class="hljs-comment">// %rd6 = input/output_ptr (数据从这里读取并写入这里)</span><br>ld.param.u64 %rd5, [_Z6Layer3PhS__param_1]; <span class="hljs-comment">// %rd5 = another output_ptr (用于最终写入)</span><br><br><span class="hljs-comment">// 获取线程和块 ID 并计算全局线程索引</span><br>mov.u32 %r21, %ntid.x;  <span class="hljs-comment">// %r21 = num_threads_per_block.x</span><br>mov.u32 %r1, %ctaid.x;  <span class="hljs-comment">// %r1 = block_id.x</span><br>mul.lo.s32 %r49, %r1, %r21; <span class="hljs-comment">// %r49 = block_id.x * num_threads_per_block.x (块的基偏移量)</span><br>mov.u32 %r3, %tid.x;    <span class="hljs-comment">// %r3 = thread_id.x</span><br>add.s32 %r22, %r49, %r3; <span class="hljs-comment">// %r22 = 全局线程索引</span><br><br><span class="hljs-comment">// 计算初始读/写地址</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd1, %r22;    <span class="hljs-comment">// 将全局线程索引转换为 64 位</span><br>cvta.to.global.u64 %rd2, %rd6; <span class="hljs-comment">// 将 input/output_ptr 转换为全局内存地址</span><br>add.s64 %rd3, %rd2, %rd1;  <span class="hljs-comment">// %rd3 = global_input_output_ptr + global_thread_index。要操作的地址。</span><br><br><span class="hljs-comment">// 第一次 XOR 操作</span><br>cvt.u<span class="hljs-number">16.</span>u32 %rs8, %r3;  <span class="hljs-comment">// 将 thread_id.x 转换为 16 位</span><br>cvt.u<span class="hljs-number">16.</span>u32 %rs9, %r1;  <span class="hljs-comment">// 将 block_id.x 转换为 16 位</span><br><span class="hljs-keyword">or</span>.b16 %rs10, %rs9, %rs8; <span class="hljs-comment">// %rs10 = (block_id.x OR thread_id.x) (16 位)</span><br>ld.global.u8 %rs11, [%rd3]; <span class="hljs-comment">// 从 %rd3 的全局内存加载 1 字节到 %rs11</span><br><span class="hljs-keyword">xor</span>.b16 %rs12, %rs11, %rs10; <span class="hljs-comment">// %rs12 = loaded_byte XOR (%rs10)</span><br>st.global.u8 [%rd3], %rs12; <span class="hljs-comment">// 将结果存储回相同的全局内存位置 (%rd3)</span><br><br>bar.sync <span class="hljs-number">0</span>; <span class="hljs-comment">// 同步块内的所有线程。这在读取可能已被块内其他线程写入的数据之前至关重要。</span><br><br><span class="hljs-comment">// 条件哈希类计算</span><br><span class="hljs-keyword">and</span>.b32 %r23, %r3, <span class="hljs-number">7</span>;   <span class="hljs-comment">// %r23 = thread_id.x AND 7 (检查 if thread_id.x % 8 == 0)</span><br>setp.ne.s32 %p1, %r23, <span class="hljs-number">0</span>; <span class="hljs-comment">// %p1 = 如果 (thread_id.x % 8 != 0)，则为真</span><br>@%p1 bra $L__BB2_4;     <span class="hljs-comment">// 如果 %p1 为真，则跳转到 $L__BB2_4 (跳过哈希计算)</span><br><br><span class="hljs-comment">// 只有 thread_id.x % 8 == 0 的线程才执行此块</span><br>ld.global.u32 %r47, [%rd3<span class="hljs-number">+4</span>]; <span class="hljs-comment">// 从全局内存 %rd3 + 4 加载 4 字节到 %r47 (第二个 32 位字)</span><br>ld.global.u32 %r48, [%rd3];   <span class="hljs-comment">// 从全局内存 %rd3 加载 4 字节到 %r48 (第一个 32 位字)</span><br>mov.u32 %r46, <span class="hljs-number">1786956040</span>;     <span class="hljs-comment">// %r46 = 初始常量 (哈希状态的一部分)</span><br>mov.u32 %r45, <span class="hljs-number">0</span>;              <span class="hljs-comment">// %r45 = 循环计数器（初始化为 0）</span><br><br>$L__BB2_2: <span class="hljs-comment">// 哈希类循环（迭代 3,238,567 次！）</span><br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>; <span class="hljs-comment">// 编译器提示：不要展开此循环。</span><br>shl.b32 %r26, %r48, <span class="hljs-number">4</span>;      <span class="hljs-comment">// %r26 = %r48 &lt;&lt; 4</span><br>add.s32 %r27, %r26, <span class="hljs-number">1386807340</span>; <span class="hljs-comment">// %r27 = (%r48 &lt;&lt; 4) + constant1</span><br>shr.u32 %r28, %r48, <span class="hljs-number">5</span>;      <span class="hljs-comment">// %r28 = %r48 &gt;&gt; 5</span><br>add.s32 %r29, %r28, <span class="hljs-number">2007053320</span>; <span class="hljs-comment">// %r29 = (%r48 &gt;&gt; 5) + constant2</span><br><span class="hljs-keyword">xor</span>.b32 %r30, %r29, %r27;   <span class="hljs-comment">// %r30 = %r29 XOR %r27</span><br>add.s32 %r31, %r48, %r46;   <span class="hljs-comment">// %r31 = %r48 + %r46</span><br><span class="hljs-keyword">xor</span>.b32 %r32, %r30, %r31;   <span class="hljs-comment">// %r32 = %r30 XOR %r31</span><br>add.s32 %r47, %r32, %r47;   <span class="hljs-comment">// %r47 = %r32 + %r47 (更新第一个状态变量)</span><br><br>shl.b32 %r33, %r47, <span class="hljs-number">4</span>;      <span class="hljs-comment">// %r33 = %r47 &lt;&lt; 4</span><br>add.s32 %r34, %r33, <span class="hljs-number">621668851</span>;  <span class="hljs-comment">// %r34 = (%r47 &lt;&lt; 4) + constant3</span><br>add.s32 %r35, %r46, %r47;   <span class="hljs-comment">// %r35 = %r46 + %r47</span><br><span class="hljs-keyword">xor</span>.b32 %r36, %r34, %r35;   <span class="hljs-comment">// %r36 = %r34 XOR %r35</span><br>shr.u32 %r37, %r47, <span class="hljs-number">5</span>;      <span class="hljs-comment">// %r37 = %r47 &gt;&gt; 5</span><br>add.s32 %r38, %r37, <span class="hljs-number">-862448841</span>; <span class="hljs-comment">// %r38 = (%r47 &gt;&gt; 5) + constant4</span><br><span class="hljs-keyword">xor</span>.b32 %r39, %r36, %r38;   <span class="hljs-comment">// %r39 = %r36 XOR %r38</span><br>sub.s32 %r48, %r48, %r39;   <span class="hljs-comment">// %r48 = %r48 - %r39 (更新第二个状态变量)</span><br><br>add.s32 %r46, %r46, <span class="hljs-number">-1708609273</span>; <span class="hljs-comment">// 更新下一个迭代的常量</span><br>add.s32 %r45, %r45, <span class="hljs-number">1</span>;      <span class="hljs-comment">// 递增循环计数器</span><br>setp.ne.s32 %p2, %r45, <span class="hljs-number">3238567</span>; <span class="hljs-comment">// %p2 = 如果 loop_counter != 3238567，则为真</span><br>@%p2 bra $L__BB2_2;         <span class="hljs-comment">// 如果 %p2 为真，继续哈希循环</span><br><br>st.global.u32 [%rd3], %r48;     <span class="hljs-comment">// 将更新后的第一个 32 位字存储回全局内存</span><br>st.global.u32 [%rd3<span class="hljs-number">+4</span>], %r47;   <span class="hljs-comment">// 将更新后的第二个 32 位字存储回全局内存</span><br><br>$L__BB2_4: <span class="hljs-comment">// 哈希计算或跳过后的通用路径</span><br>bar.sync <span class="hljs-number">0</span>; <span class="hljs-comment">// 同步块内的所有线程。在下一次读/写之前是必需的。</span><br><br><span class="hljs-comment">// 第二次 XOR 操作（与第一次类似）</span><br><span class="hljs-keyword">and</span>.b16 %rs16, %rs9, %rs8; <span class="hljs-comment">// %rs16 = (block_id.x AND thread_id.x) (16 位)</span><br>ld.global.u8 %rs17, [%rd3]; <span class="hljs-comment">// 从 %rd3 的全局内存加载 1 字节到 %rs17</span><br><span class="hljs-keyword">xor</span>.b16 %rs18, %rs17, %rs16; <span class="hljs-comment">// %rs18 = loaded_byte XOR (%rs16)</span><br>st.global.u8 [%rd3], %rs18; <span class="hljs-comment">// 将结果存储回相同的全局内存位置 (%rd3)</span><br><br>bar.sync <span class="hljs-number">0</span>; <span class="hljs-comment">// 同步块内的所有线程。</span><br><br><span class="hljs-comment">// T 盒和 S 盒查找与累积乘法</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd7, %r3;    <span class="hljs-comment">// 将 thread_id.x 转换为 64 位以作为 S 盒索引</span><br>mov.u64 %rd8, cuda_sbox;  <span class="hljs-comment">// %rd8 = cuda_sbox 的基地址</span><br>add.s64 %rd9, %rd8, %rd7; <span class="hljs-comment">// %rd9 = cuda_sbox_base + thread_id.x</span><br>ld.<span class="hljs-type">const</span>.u8 %rs31, [%rd9]; <span class="hljs-comment">// 从 cuda_sbox 中以 thread_id.x 为索引加载 1 字节到 %rs31 (这是一个运行中的“状态”值)</span><br><br>cvta.to.global.u64 %rd4, %rd5; <span class="hljs-comment">// 将 output_ptr (第二个参数) 转换为全局内存地址</span><br>mov.u16 %rs32, <span class="hljs-number">0</span>;         <span class="hljs-comment">// %rs32 = 16 位和的累加器（初始化为 0）</span><br>mov.u32 %r50, <span class="hljs-number">0</span>;          <span class="hljs-comment">// %r50 = 循环计数器（初始化为 0）</span><br>mov.u64 %rd14, cuda_tbox; <span class="hljs-comment">// %rd14 = cuda_tbox 的基地址</span><br><br>$L__BB2_5: <span class="hljs-comment">// T 盒/S 盒乘法循环（迭代 256 次）</span><br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>; <span class="hljs-comment">// 编译器提示：不要展开此循环。</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd10, %r49;   <span class="hljs-comment">// 将 block_base_offset (%r49 = block_id.x * num_threads_per_block.x) 转换为 64 位</span><br>add.s64 %rd11, %rd2, %rd10; <span class="hljs-comment">// %rd11 = global_input_output_ptr + block_base_offset。这似乎在访问跨块的数据。</span><br>cvt.u<span class="hljs-number">64.</span>u16 %rd12, %rs31;  <span class="hljs-comment">// 将当前 S 盒状态 (%rs31) 转换为 64 位</span><br><span class="hljs-keyword">and</span>.b64 %rd13, %rd12, <span class="hljs-number">255</span>; <span class="hljs-comment">// 掩码 %rd12 以获取低 8 位 (T 盒索引的 0-255 范围)</span><br>add.s64 %rd15, %rd14, %rd13; <span class="hljs-comment">// %rd15 = cuda_tbox_base + (S-box_state &amp; 0xFF)。T 盒查找的地址。</span><br>ld.<span class="hljs-type">const</span>.u8 %rs19, [%rd15]; <span class="hljs-comment">// 从 cuda_tbox 加载 1 字节到 %rs19 (T 盒值)</span><br><br>ld.global.u8 %rs20, [%rd11]; <span class="hljs-comment">// 从 %rd11 的全局内存加载 1 字节 (似乎是块共享输入)</span><br>mul.lo.s16 %rs21, %rs19, %rs20; <span class="hljs-comment">// %rs21 = T-box_value * loaded_byte (乘法，低 16 位)</span><br>add.s16 %rs32, %rs21, %rs32; <span class="hljs-comment">// %rs32 = %rs21 + %rs32 (累积乘积)</span><br><br>mul.lo.s16 %rs22, %rs31, <span class="hljs-number">5</span>; <span class="hljs-comment">// %rs22 = current_sbox_state * 5</span><br>add.s16 %rs31, %rs22, <span class="hljs-number">17</span>;   <span class="hljs-comment">// %rs31 = %rs22 + 17 (更新 S 盒状态以进行下一次迭代)</span><br><br>add.s32 %r49, %r49, <span class="hljs-number">1</span>;     <span class="hljs-comment">// 递增 %r49 (这意味着读取地址 %rd11 也递增)</span><br>add.s32 %r50, %r50, <span class="hljs-number">1</span>;     <span class="hljs-comment">// 递增循环计数器</span><br>setp.ne.s32 %p3, %r50, <span class="hljs-number">256</span>; <span class="hljs-comment">// %p3 = 如果 loop_counter != 256，则为真</span><br>@%p3 bra $L__BB2_5;        <span class="hljs-comment">// 如果 %p3 为真，继续 T 盒/S 盒循环</span><br><br><span class="hljs-comment">// 基于累积值的最终转换</span><br><span class="hljs-keyword">xor</span>.b32 %r18, %r1, %r3; <span class="hljs-comment">// %r18 = block_id.x XOR thread_id.x</span><br>mov.u32 %r51, <span class="hljs-number">8</span>;        <span class="hljs-comment">// %r51 = 计数器，初始化为 8</span><br><br>$L__BB2_7: <span class="hljs-comment">// 最终置换/替换循环（迭代 4,137,815 次！）</span><br>.pragma <span class="hljs-string">&quot;nounroll&quot;</span>; <span class="hljs-comment">// 编译器提示：不要展开此循环。</span><br>shl.b16 %rs23, %rs32, <span class="hljs-number">3</span>;   <span class="hljs-comment">// %rs23 = accumulated_value &lt;&lt; 3</span><br><span class="hljs-keyword">and</span>.b16 %rs24, %rs32, <span class="hljs-number">224</span>; <span class="hljs-comment">// %rs24 = accumulated_value AND 224 (0b11100000)</span><br>shr.u16 %rs25, %rs24, <span class="hljs-number">5</span>;   <span class="hljs-comment">// %rs25 = %rs24 &gt;&gt; 5</span><br><span class="hljs-keyword">or</span>.b16 %rs26, %rs25, %rs23; <span class="hljs-comment">// %rs26 = %rs25 OR %rs23 (对 %rs32 的旋转类操作)</span><br>cvt.u<span class="hljs-number">32.</span>u16 %r42, %rs26;   <span class="hljs-comment">// 将 %rs26 转换为 32 位</span><br>mad.lo.s32 %r43, %r42, <span class="hljs-number">13</span>, %r18; <span class="hljs-comment">// %r43 = %r42 * 13 + (%r18)</span><br><span class="hljs-keyword">and</span>.b32 %r44, %r51, <span class="hljs-number">255</span>;   <span class="hljs-comment">// %r44 = counter AND 255 (使用计数器的低 8 位作为索引)</span><br>cvt.u<span class="hljs-number">64.</span>u32 %rd16, %r44;   <span class="hljs-comment">// 转换为 64 位</span><br>add.s64 %rd18, %rd14, %rd16; <span class="hljs-comment">// %rd18 = cuda_tbox_base + (counter &amp; 0xFF)。T 盒查找的地址。</span><br>cvt.u<span class="hljs-number">16.</span>u32 %rs27, %r43;   <span class="hljs-comment">// 将 %r43 转换为 16 位</span><br>ld.<span class="hljs-type">const</span>.u8 %rs28, [%rd18]; <span class="hljs-comment">// 从 cuda_tbox 加载 1 字节到 %rs28</span><br><span class="hljs-keyword">xor</span>.b16 %rs29, %rs28, %rs27; <span class="hljs-comment">// %rs29 = loaded_T-box_value XOR %rs27</span><br><br>cvt.u<span class="hljs-number">64.</span>u16 %rd19, %rs29;  <span class="hljs-comment">// 将 %rs29 转换为 64 位</span><br><span class="hljs-keyword">and</span>.b64 %rd20, %rd19, <span class="hljs-number">255</span>; <span class="hljs-comment">// 掩码 %rd19 以获取低 8 位 (S 盒索引的 0-255 范围)</span><br>add.s64 %rd22, %rd8, %rd20; <span class="hljs-comment">// %rd22 = cuda_sbox_base + (%rs29 &amp; 0xFF)。S 盒查找的地址。</span><br>ld.<span class="hljs-type">const</span>.u8 %rs32, [%rd22]; <span class="hljs-comment">// 从 cuda_sbox 加载 1 字节到 %rs32 (这是此迭代的最终输出字节)</span><br><br>add.s32 %r51, %r51, <span class="hljs-number">1</span>;     <span class="hljs-comment">// 递增计数器</span><br>setp.ne.s32 %p4, %r51, <span class="hljs-number">4137823</span>; <span class="hljs-comment">// %p4 = 如果 counter != 4137823，则为真</span><br>@%p4 bra $L__BB2_7;        <span class="hljs-comment">// 如果 %p4 为真，继续最终循环</span><br><br>add.s64 %rd23, %rd4, %rd1; <span class="hljs-comment">// %rd23 = global_output_ptr (第二个参数) + global_thread_index。最终输出地址。</span><br>st.global.u8 [%rd23], %rs32; <span class="hljs-comment">// 将最终转换后的字节 (%rs32) 存储到全局输出内存。</span><br>ret; <span class="hljs-comment">// 从内核返回。</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="分析推导">分析推导</h4>
<p><strong>Layer1</strong>:二维卷积操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asm">ld.param.u64 %rd5, [_Z6Layer1PhS__param_0];  // 输入指针<br>ld.param.u64 %rd6, [_Z6Layer1PhS__param_1];  // 输出指针<br>setp.lt.u32 %p1, %r1, 241;  // 检查threadIdx.x &lt; 241<br>setp.lt.u32 %p2, %r2, 241;  // 检查blockIdx.x &lt; 241<br></code></pre></td></tr></table></figure>
<p>边界检查，只处理前 241x241 的网格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asm">mov.f32 %f10, 0f00000000;   // 累加器初始化为0.0<br>mov.u64 %rd8, cuda_motion;  // 加载motion矩阵地址<br><br>$L__BB0_3:  // 外层循环 (i=0-15)<br>add.s32 %r13, %r20, %r2;    // bid + i<br>shl.b32 %r14, %r20, 4;      // i*16<br>sub.s32 %r16, %r15, %r14;   // 240 - i*16 → motion起始索引<br><br>$L__BB0_4:  // 内层循环 (j=0-15)<br>ld.global.u8 %rs1, [%rd10];  // 加载输入字节<br>cvt.rn.f32.u16 %f7, %rs1;   // 字节转浮点<br>ld.const.f32 %f8, [%rd14];  // 加载motion权重<br>fma.rn.f32 %f10, %f8, %f7, %f10;  // 乘加累加<br>cvt.rzi.u32.f32 %r17, %f10;  // 浮点转整数(截断)<br>st.global.u8 [%rd13], %r17;  // 存储结果字节<br></code></pre></td></tr></table></figure>
<p>还原：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">layer1</span>(<span class="hljs-params">input_data</span>):<br>    block_dim = <span class="hljs-number">256</span><br>    output = [<span class="hljs-number">0</span>] * (<span class="hljs-number">256</span> * <span class="hljs-number">256</span>)<br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">241</span>):  <span class="hljs-comment"># 块索引限制</span><br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">241</span>):  <span class="hljs-comment"># 线程索引限制</span><br>            total = <span class="hljs-number">0.0</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):  <span class="hljs-comment"># 外层循环</span><br>                motion_idx = <span class="hljs-number">240</span> - i * <span class="hljs-number">16</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):  <span class="hljs-comment"># 内层循环</span><br>                    input_idx = (bid + i) * block_dim + (tid + j)<br>                    total += cuda_motion[motion_idx + j] * input_data[input_idx]<br>            <br>            output[bid * block_dim + tid] = <span class="hljs-built_in">int</span>(total) &amp; <span class="hljs-number">0xFF</span><br>    <br>    <span class="hljs-keyword">return</span> output<br></code></pre></td></tr></table></figure>
<p><strong>Layer2</strong>: 置换操作，使用 sbox
对每个像素的位置进行重新排列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asm">mad.lo.s32 %r4, %r1, %r2, %r3;  // 计算输入索引: blockIdx.x*blockDim.x + threadIdx.x<br>ld.global.u8 %rs1, [%rd6];       // 加载输入字节<br><br>ld.const.u8 %r5, [%rd9];  // sbox[threadIdx.x]<br>ld.const.u8 %r6, [%rd11]; // sbox[blockIdx.x]<br><br>mad.lo.s32 %r7, %r2, %r5, %r6;  // 计算新位置: blockDim.x * sbox[tid] + sbox[bid]<br>st.global.u8 [%rd13], %rs1;      // 存储到新位置<br></code></pre></td></tr></table></figure>
<p>还原：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">layer2</span>(<span class="hljs-params">input_data</span>):<br>    block_dim = <span class="hljs-number">256</span><br>    output = [<span class="hljs-number">0</span>] * (<span class="hljs-number">256</span> * <span class="hljs-number">256</span>)<br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            input_idx = bid * block_dim + tid<br>            new_idx = block_dim * cuda_sbox[tid] + cuda_sbox[bid]<br>            output[new_idx] = input_data[input_idx]<br>    <br>    <span class="hljs-keyword">return</span> output<br></code></pre></td></tr></table></figure>
<p><strong>Layer3</strong>: 核心加密操作</p>
<p>1.初次异或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asm">or.b16 %rs10, %rs9, %rs8;  // bid | tid<br>xor.b16 %rs12, %rs11, %rs10;  // buffer ^= (bid | tid)<br>st.global.u8 [%rd3], %rs12;<br>bar.sync 0;  // 同步<br></code></pre></td></tr></table></figure>
<p>推导：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        idx = bid * <span class="hljs-number">256</span> + tid<br>        buffer[idx] ^= bid | tid<br></code></pre></td></tr></table></figure>
<p>2.类似 TEA 的加密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs asm">and.b32 %r23, %r3, 7;      // tid &amp; 7<br>setp.ne.s32 %p1, %r23, 0;  // 检查是否执行加密<br>@%p1 bra $L__BB2_4;        // 条件跳转<br><br>// 加密核心<br>ld.global.u32 %r47, [%rd3+4];  // 加载高位字<br>ld.global.u32 %r48, [%rd3];    // 加载低位字<br>mov.u32 %r46, 1786956040;      // 初始常量<br><br>$L__BB2_2:  // 加密循环 (3,238,567轮)<br>// 更新高位字<br>shl.b32 %r26, %r48, 4;        // v0 &lt;&lt; 4<br>add.s32 %r27, %r26, 1386807340; <br>shr.u32 %r28, %r48, 5;        // v0 &gt;&gt; 5<br>add.s32 %r29, %r28, 2007053320;<br>xor.b32 %r30, %r29, %r27;     // (v0&gt;&gt;5 + C2) ^ (v0&lt;&lt;4 + C1)<br>add.s32 %r31, %r48, %r46;     // v0 + sum<br>xor.b32 %r32, %r30, %r31;     // 二次异或<br>add.s32 %r47, %r32, %r47;     // v1 += ...<br><br>// 更新低位字<br>shl.b32 %r33, %r47, 4;        // v1 &lt;&lt; 4<br>add.s32 %r34, %r33, 621668851;<br>add.s32 %r35, %r46, %r47;     // sum + v1<br>xor.b32 %r36, %r34, %r35;     // (v1&lt;&lt;4 + C3) ^ (sum+v1)<br>shr.u32 %r37, %r47, 5;        // v1 &gt;&gt; 5<br>add.s32 %r38, %r37, -862448841;<br>xor.b32 %r39, %r36, %r38;     // 二次异或<br>sub.s32 %r48, %r48, %r39;     // v0 -= ...<br><br>// 更新常量<br>add.s32 %r46, %r46, -1708609273;  // sum += delta<br></code></pre></td></tr></table></figure>
<p>推导：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">or</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">8</span>):<br>        idx = bid * <span class="hljs-number">256</span> + tid<br>        <span class="hljs-comment"># 读取8字节(2个32位字)</span><br>        v0 = <span class="hljs-built_in">int</span>.from_bytes(buffer[idx:idx+<span class="hljs-number">4</span>], <span class="hljs-string">&#x27;little&#x27;</span>)<br>        v1 = <span class="hljs-built_in">int</span>.from_bytes(buffer[idx+<span class="hljs-number">4</span>:idx+<span class="hljs-number">8</span>], <span class="hljs-string">&#x27;little&#x27;</span>)<br>        s = <span class="hljs-number">1786956040</span><br>        <br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3238567</span>):<br>            <span class="hljs-comment"># 更新v1</span><br>            t1 = ((v0 &lt;&lt; <span class="hljs-number">4</span>) + <span class="hljs-number">1386807340</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            t2 = ((v0 &gt;&gt; <span class="hljs-number">5</span>) + <span class="hljs-number">2007053320</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            t3 = (t1 ^ t2) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            v1 = (v1 + (t3 ^ (v0 + s))) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            <br>            <span class="hljs-comment"># 更新v0</span><br>            t1 = ((v1 &lt;&lt; <span class="hljs-number">4</span>) + <span class="hljs-number">621668851</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            t2 = ((v1 &gt;&gt; <span class="hljs-number">5</span>) - <span class="hljs-number">862448841</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            t3 = (t1 ^ (s + v1)) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            v0 = (v0 - (t3 ^ t2)) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            <br>            <span class="hljs-comment"># 更新常量</span><br>            s = (s - <span class="hljs-number">1708609273</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>        <br>        <span class="hljs-comment"># 写回结果</span><br>        buffer[idx:idx+<span class="hljs-number">4</span>] = v0.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br>        buffer[idx+<span class="hljs-number">4</span>:idx+<span class="hljs-number">8</span>] = v1.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>3.二次异或：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asm">and.b16 %rs16, %rs9, %rs8;  // bid &amp; tid<br>xor.b16 %rs18, %rs17, %rs16;  // buffer ^= (bid &amp; tid)<br>st.global.u8 [%rd3], %rs18;<br>bar.sync 0;  // 同步<br></code></pre></td></tr></table></figure>
<p>推导：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    idx = bid * <span class="hljs-number">256</span> + tid<br>    buffer[idx] ^= bid &amp; tid<br></code></pre></td></tr></table></figure>
<p>4.T 盒/S 盒 累加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asm">ld.const.u8 %rs31, [%rd9];  // sbox_val = sbox[tid]<br>mov.u16 %rs32, 0;           // 累加器初始化<br><br>$L__BB2_5:  // 累加循环 (256次)<br>ld.const.u8 %rs19, [%rd15];  // tbox[sbox_val]<br>ld.global.u8 %rs20, [%rd11]; // 加载输入字节<br>mul.lo.s16 %rs21, %rs19, %rs20;  // tbox[sbox] * buffer[i]<br>add.s16 %rs32, %rs21, %rs32;     // 累加<br><br>// 更新S盒值<br>mul.lo.s16 %rs22, %rs31, 5;<br>add.s16 %rs31, %rs22, 17;   // sbox_val = sbox_val * 5 + 17<br></code></pre></td></tr></table></figure>
<p>推导：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        s_val = cuda_sbox[tid]<br>        accum = <span class="hljs-number">0</span><br>        <br>        <span class="hljs-comment"># 处理整个块</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            idx = bid * <span class="hljs-number">256</span> + i<br>            accum += cuda_tbox[s_val] * buffer[idx]<br>            s_val = (s_val * <span class="hljs-number">5</span> + <span class="hljs-number">17</span>) &amp; <span class="hljs-number">0xFF</span><br>        <br>        <span class="hljs-comment"># 保留16位结果</span><br>        accum &amp;= <span class="hljs-number">0xFFFF</span><br></code></pre></td></tr></table></figure>
<p>5.混淆循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asm">$L__BB2_7:  // 混淆循环 (4,137,815轮)<br>// 循环左移3位<br>shl.b16 %rs23, %rs32, 3;     // 低13位左移3位<br>and.b16 %rs24, %rs32, 224;   // 0xE0 (高3位)<br>shr.u16 %rs25, %rs24, 5;     // 高3位右移5位<br>or.b16 %rs26, %rs25, %rs23;  // 组合 → 循环左移3位<br><br>// 非线性变换<br>mad.lo.s32 %r43, %r42, 13, %r18;  // rotated*13 + (bid^tid)<br>ld.const.u8 %rs28, [%rd18];  // tbox[i &amp; 0xFF]<br>xor.b16 %rs29, %rs28, %rs27; // tbox[i] ^ LSB(t)<br>ld.const.u8 %rs32, [%rd22];  // sbox[result] → 更新累加器<br></code></pre></td></tr></table></figure>
<p>推导：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        mixer = bid ^ tid<br>        <br>        <span class="hljs-comment"># 混淆循环 (从8开始)</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>, <span class="hljs-number">4137823</span>):<br>            <span class="hljs-comment"># 16位循环左移3位</span><br>            rotated = ((accum &lt;&lt; <span class="hljs-number">3</span>) | (accum &gt;&gt; <span class="hljs-number">13</span>)) &amp; <span class="hljs-number">0xFFFF</span><br>            <br>            <span class="hljs-comment"># 乘加运算</span><br>            t_val = rotated * <span class="hljs-number">13</span> + mixer<br>            <br>            <span class="hljs-comment"># T盒/S盒变换</span><br>            tbox_val = cuda_tbox[i &amp; <span class="hljs-number">0xFF</span>]<br>            s_idx = tbox_val ^ (t_val &amp; <span class="hljs-number">0xFF</span>)<br>            accum = cuda_sbox[s_idx]<br>        <br>        output[bid * <span class="hljs-number">256</span> + tid] = accum &amp; <span class="hljs-number">0xFF</span><br></code></pre></td></tr></table></figure>
<p>完整加密过程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">layer1</span>(<span class="hljs-params">input_data</span>):<br>    block_dim = <span class="hljs-number">256</span><br>    output = [<span class="hljs-number">0</span>] * (<span class="hljs-number">256</span> * <span class="hljs-number">256</span>)<br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">241</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">241</span>):<br>            total = <span class="hljs-number">0.0</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>                motion_idx = <span class="hljs-number">240</span> - i * <span class="hljs-number">16</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>                    input_idx = (bid + i) * block_dim + (tid + j)<br>                    total += cuda_motion[motion_idx + j] * input_data[input_idx]<br>            <br>            output[bid * block_dim + tid] = <span class="hljs-built_in">int</span>(total) &amp; <span class="hljs-number">0xFF</span><br>    <br>    <span class="hljs-keyword">return</span> output<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">layer2</span>(<span class="hljs-params">input_data</span>):<br>    block_dim = <span class="hljs-number">256</span><br>    output = [<span class="hljs-number">0</span>] * (<span class="hljs-number">256</span> * <span class="hljs-number">256</span>)<br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            input_idx = bid * block_dim + tid<br>            new_idx = block_dim * cuda_sbox[tid] + cuda_sbox[bid]<br>            output[new_idx] = input_data[input_idx]<br>    <br>    <span class="hljs-keyword">return</span> output<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">layer3</span>(<span class="hljs-params">input_data</span>):<br>    block_dim = <span class="hljs-number">256</span><br>    buffer = <span class="hljs-built_in">bytearray</span>(input_data)  <br>    output = [<span class="hljs-number">0</span>] * (<span class="hljs-number">256</span> * <span class="hljs-number">256</span>)<br>    <br><br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            idx = bid * block_dim + tid<br>            buffer[idx] ^= bid | tid<br>    <br><br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">8</span>):<br>            idx = bid * block_dim + tid<br><br>            v0 = <span class="hljs-built_in">int</span>.from_bytes(buffer[idx:idx+<span class="hljs-number">4</span>], <span class="hljs-string">&#x27;little&#x27;</span>)<br>            v1 = <span class="hljs-built_in">int</span>.from_bytes(buffer[idx+<span class="hljs-number">4</span>:idx+<span class="hljs-number">8</span>], <span class="hljs-string">&#x27;little&#x27;</span>)<br>            s = <span class="hljs-number">1786956040</span><br>            <br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3238567</span>):<br><br>                t1 = ((v0 &lt;&lt; <span class="hljs-number">4</span>) + <span class="hljs-number">1386807340</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                t2 = ((v0 &gt;&gt; <span class="hljs-number">5</span>) + <span class="hljs-number">2007053320</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                t3 = (t1 ^ t2) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                v1 = (v1 + (t3 ^ (v0 + s))) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                <br>                t1 = ((v1 &lt;&lt; <span class="hljs-number">4</span>) + <span class="hljs-number">621668851</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                t2 = ((v1 &gt;&gt; <span class="hljs-number">5</span>) - <span class="hljs-number">862448841</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                t3 = (t1 ^ (s + v1)) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                v0 = (v0 - (t3 ^ t2)) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>                <br>                s = (s - <span class="hljs-number">1708609273</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            <br>            buffer[idx:idx+<span class="hljs-number">4</span>] = v0.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br>            buffer[idx+<span class="hljs-number">4</span>:idx+<span class="hljs-number">8</span>] = v1.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            idx = bid * block_dim + tid<br>            buffer[idx] ^= bid &amp; tid<br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            s_val = cuda_sbox[tid]<br>            accum = <span class="hljs-number">0</span><br>            <br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>                idx = bid * block_dim + i<br>                accum = (accum + cuda_tbox[s_val] * buffer[idx]) &amp; <span class="hljs-number">0xFFFF</span><br>                s_val = (s_val * <span class="hljs-number">5</span> + <span class="hljs-number">17</span>) &amp; <span class="hljs-number">0xFF</span><br>    <br>    <span class="hljs-keyword">for</span> bid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> tid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            mixer = bid ^ tid<br>            <br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>, <span class="hljs-number">4137823</span>):<br>                rotated = ((accum &lt;&lt; <span class="hljs-number">3</span>) | (accum &gt;&gt; <span class="hljs-number">13</span>)) &amp; <span class="hljs-number">0xFFFF</span><br>                <br>                t_val = rotated * <span class="hljs-number">13</span> + mixer<br>                <br>                tbox_val = cuda_tbox[i &amp; <span class="hljs-number">0xFF</span>]<br>                s_idx = tbox_val ^ (t_val &amp; <span class="hljs-number">0xFF</span>)<br>                accum = cuda_sbox[s_idx]<br><br>            output[bid * block_dim + tid] = accum &amp; <span class="hljs-number">0xFF</span><br>    <br>    <span class="hljs-keyword">return</span> output<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">input_data</span>):<br>    l1 = layer1(input_data)<br>    l2 = layer2(l1)<br>    l3 = layer3(l2)<br>    <span class="hljs-keyword">return</span> l3<br></code></pre></td></tr></table></figure>
<p>接下来就是从 Layer3 开始逐层倒着解密</p>
<p>详细参考</p>
<p><a target="_blank" rel="noopener" href="https://astralprisma.github.io/2025/04/27/actf_25/">棱晶 の
wp</a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Reverse/" class="print-no-link">#Reverse</a>
      
        <a href="/tags/cuda/" class="print-no-link">#cuda</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>cuda 逆向</div>
      <div>http://example.com/2025/07/21/cuda/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Eleven</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/08/01/llvm/" title="llvm 浅探">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">llvm 浅探</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/20/XYCTF2025/" title="XYCTF2025 Reverse 方向复现">
                        <span class="hidden-mobile">XYCTF2025 Reverse 方向复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
